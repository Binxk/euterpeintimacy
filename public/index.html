<!DOCTYPE html>
<html lang="en">
</head>
<body><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euterpe's Intimacy</title>
    <style>
        .posts-container {
            border: 1px solid #000000;
            padding: 20px;
            margin: 10px auto;
            max-width: 800px;
        }
    </style>
</head>
    <div class="container">
        <h1>Euterpe's Intimacy</h1>

        <div id="user-info">
            <div>
                Logged in as: <span id="username"></span>
            </div>
            <button onclick="logout()">Logout</button>
        </div>

        <div id="post-form">
            <h2>Create Your Post</h2>
            <form id="create-post-form" enctype="multipart/form-data">
                <div class="form-group">
                    <input type="text" id="title" name="title" placeholder="Title" required>
                </div>
                <div class="form-group">
                    <textarea id="content" name="content" placeholder="Content" required></textarea>
                </div>
                <div class="form-group">
                    <input type="file" id="image" name="image" accept="image/*">
                </div>
                <button type="submit">Create Post</button>
            </form>
        </div>

        <div id="posts" class="posts-container">
            <!-- Posts will be dynamically inserted here -->
        </div>
    </div>

    <script>
        // Function to check authentication status
        async function checkAuth() {
            try {
                const response = await fetch('/check-session');
                const data = await response.json();
                if (data.authenticated) {
                    document.getElementById('username').textContent = data.user.username;
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }

        // Function to handle logout
        async function logout() {
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Function to load posts
        async function loadPosts() {
            try {
                const response = await fetch('/posts');
                const posts = await response.json();
                const postsContainer = document.getElementById('posts');
                postsContainer.innerHTML = '';

                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'post';
                    let postContent = `
                        <h3>${post.title}</h3>
                        <p>${post.content}</p>
                        <p>Posted by: ${post.author.username}</p>
                    `;
                    
                    // Add image if present
                    if (post.image) {
                        postContent += `<img src="${post.image}" alt="Post image" class="post-image">`;
                    }

                    postElement.innerHTML = postContent;
                    postsContainer.appendChild(postElement);
                });
            } catch (error) {
                console.error('Failed to load posts:', error);
            }
        }

        // Handle form submission
        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', document.getElementById('title').value);
            formData.append('content', document.getElementById('content').value);
            const imageFile = document.getElementById('image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            try {
                const response = await fetch('/post', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('create-post-form').reset();
                    loadPosts();
                }
            } catch (error) {
                console.error('Failed to create post:', error);
            }
        });

        // Initialize
        checkAuth();
        loadPosts();
    </script>
</body>
</html>